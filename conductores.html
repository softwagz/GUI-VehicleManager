<!DOCTYPE html>
<html lang="en" ng-app="mainController">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conductores</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="./assets/css/conductoresStyle.css">

    <script src="./assets/js/angularJs.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
</head>

<body>
    <div class="d-flex" id="wrapper" ng-controller="conductoresController">
        <div class="bg-light border-right" id="sidebar-wrapper">
            <div class="sidebar-heading">Start Bootstrap </div>
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action bg-light">Dashboard</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Shortcuts</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Overview</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Events</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Profile</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Status</a>
            </div>
        </div>

        <button class="btn btn-primary" id="menu-toggle">Toggle Menu</button>

        <div class="main-container">
            <header class="head">
                <h2>Gestion de Conductores</h2>
            </header>
            <div class=" body">
                <h3 class="text-registro">Registro</h3>
                <h3 class="text-lista">Lista</h3>

                <div class="container-registro" id="assig">
                    <div class="content">
                        <div class="formRegistro">
                            <input ng-model="newUser.rut" placeholder="RUT" type="text" class="form-control rut input"
                                id="rut" name="rut" required />



                            <input ng-model="newUser.nombre" placeholder="Nombre" type="text"
                                class="form-control nombre input" id="nombre" name="nombre" required />



                            <input ng-model="newUser.apellido" placeholder="Apellido" type="text"
                                class="form-control apellido input" id="apellido" name="apellido" required />

                            <span class="textlogin badge badge-pill badge-primary">LOGIN</span>
                            <input ng-model="newUser.usuario" placeholder="Usuario" type="text"
                                class="form-control usuario input" id="usuario" name="usuario" required />



                            <input ng-model="newUser.clave" placeholder="Clave" type="text"
                                class="form-control clave input" id="clave" name="clave" required />

                            <div class="input">

                                <button type="button" class="btn btn-primary" ng-click="agregarUsuario()">Save</button>
                                <button type="button" ng-click="clear()" class="btn btn-danger">Cancel</button>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-lista" id="disp">
                    <div class="content-user" ng-repeat="conductor in listConductores">
                        <img src="https://img2.freepng.es/20180331/eow/kisspng-computer-icons-user-clip-art-user-5abf13db298934.2968784715224718991702.jpg"
                            class="img-user">
                        <div class="detalle-user">
                            <p><strong>RUT </strong> {{conductor.rut}}</p>
                            <p><strong>Nombre </strong>{{conductor.nombre}}</p>
                            <p><strong>Apellido </strong>{{conductor.apellido}}</p>
                            <p><strong>Usuario </strong>{{conductor.usuario}}</p>
                            <p><Strong>Clave </Strong>{{conductor.clave}}</p>
                        </div>
                        <div class="opcines-user">
                            <button ng-click="deleteConductor(conductor.rut)" class="btn btn-block btn-warning">
                                Eliminar</button>
                            <button ng-click="editarConductor(conductor)" data-toggle="modal"
                                data-target="#modalEditarCondutor" class="btn btn-block btn-primary">Editar</button>
                        </div>

                    </div>
                </div>

            </div>
            <footer class="foo">
                <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Modi, excepturi.</p>
            </footer>

        </div>
    </div>

        <!-- MODAL ---------------------------------------------------- -->


        <div class="modal fade" id="modalEditarCondutor" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">
                            Editar Conductor
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <input class="form-control" ng-model="conductorSelected.nombre" type="text" name="nombre"
                                id="nombre" value="{{conductorSelected.nombre}}">
                        </div>
                        <div class="form-group">
                            <input class="form-control" ng-model="conductorSelected.apellido" type="text"
                                name="apellido" id="apellido" value="{{conductorSelected.apellido}}">
                        </div>
                        <div class="form-group">
                            <input class="form-control" ng-model="conductorSelected.usuario" type="text" name="usuario"
                                id="usuario" value="{{conductorSelected.usuario}}">
                        </div>
                        <div class="form-group">
                            <input class="form-control" ng-model="conductorSelected.clave" type="text" name="clave"
                                id="clave" value="{{conductorSelected.clave}}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" ng-click="guardarCambiosConductor()" class="btn btn-primary">Save
                            changes</button>
                    </div>
                </div>
            </div>
        </div>


        <script>
            // Menu Laterañ

            $("#menu-toggle").click(function (e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });

            //Controlador

            const ang = angular.module('mainController', []);
            const jquery = $;

            ang.controller('conductoresController', ($scope, $http) => {
                $scope.listConductores = [];
                $scope.search = '';
                $scope.newUser = {
                    rut: '',
                    nombre: '',
                    apellido: '',
                    usuario: '',
                    clave: ''
                }

                $scope.conductorSelected = {
                    id: '',
                    rut: '',
                    nombre: '',
                    apellido: '',
                    usuario: '',
                    clave: ''
                }

                $scope.buscar = () => {
                    $http({
                        method: 'POST',
                        url: 'http://localhost:4000/api/web/buscarUsuario',
                        data: { rut: $scope.search }
                    }).then(function successCallback(response) {
                        if (response.data != -1) {
                            console.log(response);
                            alert('encontrado');
                            $scope.listConductores.splice(0);
                            $scope.listConductores.push(response.data);
                        } else {
                            alert('No ay coincidencias');
                        }
                    }, function errorCallback(response) {

                        console.log("Error Countries", response);

                    });
                }

                $scope.editarConductor = (conductor) => {
                    console.log(conductor.nombre);
                    $scope.conductorSelected = {
                        id: conductor._id,
                        rut: conductor.rut,
                        nombre: conductor.nombre,
                        apellido: conductor.apellido,
                        usuario: conductor.usuario,
                        clave: conductor.clave
                    }
                    console.log('añadido')
                }

                $scope.deleteConductor = (rut) => {
                    $http({
                        method: 'PUT',
                        url: 'http://localhost:4000/api/web/borrarUsuario',
                        data: {
                            rut: rut,
                            status: false
                        }
                    }).then(function successCallback(response) {

                        console.log("Success", response);
                        alert('Usuario Eliminado');
                        loadConductores($http, $scope);

                    }, function errorCallback(response) {

                        console.log("Error Countries", response);

                    });
                }
                $scope.guardarCambiosConductor = () => {
                    $http({
                        method: 'PUT',
                        url: 'http://localhost:4000/api/web/modificarUsuario',
                        data: $scope.conductorSelected
                    }).then(function successCallback(response) {

                        $scope.conductorSelected = response.data;
                        console.log("Success", response);
                        alert('Operacion Exitosa');
                        loadConductores($http, $scope);

                    }, function errorCallback(response) {

                        console.log("Error Countries", response);

                    });
                }

                $scope.agregarUsuario = () => {
                    $http({
                        method: 'POST',
                        url: 'http://localhost:4000/api/web/agregarUsuario',
                        data: $scope.newUser
                    }).then(function successCallback(response) {
                        loadConductores($http, $scope);
                        console.log("Success", response);
                        if (response.data == -1) {
                            alert('El rut ya esta registrado');
                        } else {
                            alert('registro exitoso');
                        }

                    }, function errorCallback(response) {

                        console.log("Error Countries", response);

                    });


                }

                $scope.clear = () => {
                    $scope.newUser = {
                        rut: '',
                        nombre: '',
                        apellido: '',
                        usuario: '',
                        clave: ''
                    }
                }



                loadConductores($http, $scope);



            });

            function loadConductores($http, $scope) {
                $http({
                    method: 'GET',
                    url: 'http://localhost:4000/api/web/listarUsuarios'
                }).then(function successCallback(response) {
                    $scope.listConductores.splice(0);
                    response.data.map((conductor) => {
                        if (conductor['status'] == true) {
                            $scope.listConductores.push(conductor);
                            console.log("Success", response);
                        }
                    })

                }, function errorCallback(response) {

                    console.log("Error Countries", response);

                });
            }

        </script>

</body>

</html>